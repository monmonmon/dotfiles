#!/bin/sh

# 長ーいamazonのURLを短く！
# Amazon URLをクリップボードから読んで、短く変換して、クリップボードに書き込み返す(ﾟ∀ﾟ)
# 例：
# https://www.amazon.co.jp/%E5%85%A5%E9%96%80Mercurial-Linux-Windows%E5%AF%BE%E5%BF%9C-%E8%97%A4%E5%8E%9F-%E5%85%8B%E5%89%87/dp/4798021741/ref=sr_1_1?ie=UTF8&qid=1340773631&sr=8-1
# ↓
# https://www.amazon.co.jp/exec/obidos/ASIN/4798021741
#
# SAMPLES
# https://www.amazon.com/exec/obidos/tg/detail/-/B00ABVIIS4
# https://www.amazon.com/gp/product/B00ABVIIS4
# https://www.amazon.com/o/ASIN/B00ABVIIS4
# https://www.amazon.com/dp/B00ABVIIS4
# https://www.amazon.com/dp/product/B00ABVIIS4
# https://www.amazon.com/<ProductName>/dp/B00ABVIIS4

# Amazon URLをクリップボードから受け取る
#url=$(pbpaste)
url=$1
if [ -z "$url" ]; then
    url="$1"
    if [ -z "$url" ]; then
        echo "hmmm"
        exit 1
    fi
fi

# URLからASINを探して切り出す
asin_isbn=$(echo "$url" | gawk '{print gensub(/.*\/([a-zA-Z0-9]{10})\/?.*/, "\\1", 1)}')
# asin_isbn=$(echo "$url" | sed -n 's/.*www\.amazon\.co\.jp\/.*\/[a-z][a-z]\/\([A-Za-z0-9]*\).*$/\1/ p')
# if [ -n "$asin_isbn" ]; then
#     asin_isbn=$(echo "$url" | sed -n 's/.*www\.amazon\.co\.jp\/[a-z][a-z]\/\([A-Za-z0-9]*\).*$/\1/ p')
# fi

if [ -n "$asin_isbn" ]; then
	#amazonurl="https://www.amazon.co.jp/exec/obidos/ASIN/$asin_isbn"
	amazonurl="https://www.amazon.co.jp/dp/$asin_isbn"
	echo $amazonurl
	#echo "$amazonurl\c" | pbcopy
else
	echo ':P'
fi
